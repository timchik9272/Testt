<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Сокращатель ссылок — vyy.netlify.app</title>
  <meta name="google-site-verification" content="2RGccrSRPOqq_ke9AJ-s9yIk8kKdZsrVo5zhkiGOPrU" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#f7f8fa; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --primary:#3b82f6; --primary-600:#2563eb; --ring:rgba(59,130,246,.35);
      --shadow:0 6px 18px rgba(0,0,0,.08);
      --radius:14px; --danger:#ef4444; --danger-600:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, system-ui, Arial;
      display:flex; flex-direction:column; align-items:center; padding:24px;
    }
    .container{width:100%; max-width:720px}
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px;
    }
    .brand{font-size:22px; font-weight:700; letter-spacing:.2px}
    .status{
      padding:8px 12px; border-radius:999px; background:#eef2ff; color:#4338ca; font-weight:600; font-size:14px;
      white-space:nowrap;
    }
    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px; margin-bottom:16px;
    }
    label{display:block; font-size:13px; color:var(--muted); margin-top:8px}
    input{
      width:100%; padding:12px 14px; font-size:16px; margin-top:6px;
      border:1px solid #e5e7eb; border-radius:12px; outline:0; background:#fff;
      transition:border-color .15s, box-shadow .15s;
    }
    input:focus{border-color:var(--primary); box-shadow:0 0 0 4px var(--ring)}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:560px){ .row{grid-template-columns:2fr 1fr} }
    .btn{
      width:100%; padding:13px 16px; border:0; border-radius:12px; cursor:pointer;
      background:var(--primary); color:#fff; font-size:16px; font-weight:700;
      transition:transform .05s ease, background .15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn:hover{background:var(--primary-600)}
    .btn-danger{background:var(--danger)}
    .btn-danger:hover{background:var(--danger-600)}
    .muted{color:var(--muted); font-size:14px}
    .list .item{
      background:#fff; border:1px solid #eef2f7; border-radius:12px; padding:12px;
      display:flex; flex-direction:column; gap:6px;
    }
    .list{display:grid; gap:10px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .link{
      color:var(--primary-600); text-decoration:none; word-break:break-all;
    }
    .top-actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px}
    .pill{
      padding:8px 10px; border-radius:999px; background:#f3f4f6; color:#111827; font-weight:600; font-size:13px;
    }
    .ghost{
      background:#fff; color:#111827; border:1px solid #e5e7eb;
    }
    .copy, .edit-btn, .delete-btn{
      padding:8px 10px; border-radius:10px; border:1px dashed #d1d5db; background:#fff; font-size:13px; cursor:pointer;
      text-align:center;
    }
    .actions {
      display: flex; gap: 8px; margin-top: 6px; flex-wrap: wrap;
    }
    .empty{padding:10px 4px; color:var(--muted)}
    .auth-link{font-weight:700; text-decoration:none}
    footer{margin-top:16px; color:var(--muted); font-size:12px}
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }
    .modal-content {
      background: var(--card); padding: 20px; border-radius: var(--radius); max-width: 500px; width: 90%;
      box-shadow: var(--shadow);
    }
    .modal-actions {
      display: flex; gap: 10px; margin-top: 16px; justify-content: flex-end; flex-wrap: wrap;
    }
    .close-btn {cursor: pointer; font-size: 14px;}
    .section-title {
      font-size: 16px; font-weight: 600; margin: 12px 0 6px;
    }
    hr { border: 0; border-top: 1px solid #e5e7eb; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">vyy • сокращатель</div>
      <div class="top-actions">
        <span id="status" class="status">Статус: Гость</span>
        <a id="authLink" class="pill ghost auth-link" href="/auth.html">Войти / Регистрация</a>
      </div>
    </div>

    <div class="card">
      <form id="shortenForm">
        <label>Оригинальная ссылка</label>
        <input type="url" id="urlInput" required placeholder="https://example.com/very/long/link" />
        <div class="row">
          <div>
            <label>Свой короткий код (необязательно)</label>
            <input type="text" id="customCode" inputmode="latin" pattern="[A-Za-z0-9-_.~]{1,16}" placeholder="Например: go" />
          </div>
          <div style="display:flex; align-items:flex-end">
            <button type="submit" class="btn">Сократить</button>
          </div>
        </div>
        <div class="muted" style="margin-top:6px">Короткие ссылки вида <span class="mono">https://vyy.netlify.app/&lt;код&gt;</span></div>
      </form>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px">
        <h3 style="margin:0; font-size:18px">Все ссылки</h3>
        <button id="refreshBtn" class="copy">Обновить</button>
      </div>
      <div id="linksList" class="list"></div>
      <div id="emptyState" class="empty" style="display:none">Пока пусто. Добавьте первую ссылку ↑</div>
    </div>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <h3>Редактировать ссылку</h3>
        <form id="editForm">
          <label>Оригинальная ссылка</label>
          <input type="url" id="editUrlInput" required />
          <label>Короткий код</label>
          <input type="text" id="editShortCode" required pattern="[A-Za-z0-9-_.~]{1,16}" />
          <input type="hidden" id="editLinkId" />
          <div class="modal-actions">
            <button type="button" class="copy close-btn">Отмена</button>
            <button type="submit" class="btn">Сохранить</button>
          </div>
        </form>
      </div>
    </div>

    <footer>vyy • работает на Supabase + Netlify, сгенерирован нейросетью</footer>
  </div>

  <script>
    const SUPABASE_URL = "https://nsscaoqarmfslfdtwvma.supabase.co";
    const SUPABASE_KEY = "sb_publishable_7kiQMNJIhzz-R9szKkriwg_V-KlgbUm";
    const SAFE_BROWSING_API_KEY = "AIzaSyA80adMNSwH9iJDFKpeXcgpbLF0PgPas3M";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const ADMIN_UID = "8626c0b4-d51d-4033-91fe-84d4dffd85a0";

    const statusEl = document.getElementById("status");
    const authLink = document.getElementById("authLink");
    const form = document.getElementById("shortenForm");
    const urlInput = document.getElementById("urlInput");
    const customCode = document.getElementById("customCode");
    const linksList = document.getElementById("linksList");
    const emptyState = document.getElementById("emptyState");
    const refreshBtn = document.getElementById("refreshBtn");
    const editModal = document.getElementById("editModal");
    const editForm = document.getElementById("editForm");
    const editUrlInput = document.getElementById("editUrlInput");
    const editShortCode = document.getElementById("editShortCode");
    const editLinkId = document.getElementById("editLinkId");

    async function checkUrlSafety(url) {
      try {
        const response = await fetch(`https://safebrowsing.googleapis.com/v4/threatMatches:find?key=${SAFE_BROWSING_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            client: { clientId: "vyy-shortener", clientVersion: "1.0.0" },
            threatInfo: {
              threatTypes: ["MALWARE", "SOCIAL_ENGINEERING", "UNWANTED_SOFTWARE", "POTENTIALLY_HARMFUL_APPLICATION"],
              platformTypes: ["ANY_PLATFORM"],
              threatEntryTypes: ["URL"],
              threatEntries: [{ url }]
            }
          })
        });
        const data = await response.json();
        return Object.keys(data).length > 0;
      } catch (e) {
        console.error("Ошибка проверки безопасности:", e);
        return false;
      }
    }

    function generateShortCode(length = 4) {
      const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      return Array.from({ length }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    function sanitizeCode(code) {
      return code.replace(/[^A-Za-z0-9\-_.~]/g, "").slice(0, 32);
    }

    async function getUserStatus() {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) {
        statusEl.textContent = "Статус: Гость";
        authLink.textContent = "Войти / Регистрация";
        authLink.href = "/auth.html";
        authLink.onclick = null;
        return { user: null, isAdmin: false, email: 'гость' };
      }
      const isAdmin = user.id === ADMIN_UID;
      statusEl.textContent = isAdmin ? "Статус: Админ" : "Статус: Пользователь";
      authLink.textContent = "Выйти";
      authLink.href = "#";
      authLink.onclick = async (e) => {
        e.preventDefault();
        await sb.auth.signOut();
        location.reload();
      };
      return { user, isAdmin, email: user.email };
    }

    function renderList(rows, isAdmin, userEmail) {
      if (!rows || rows.length === 0) {
        linksList.innerHTML = "";
        emptyState.style.display = "block";
        return;
      }
      emptyState.style.display = "none";
      let html = '';
      if (!userEmail || userEmail === 'гость') {
        // Для гостей отображаем только гостевые ссылки без заголовка "Ваши ссылки"
        html = renderItems(rows.filter(row => row.email === 'гость'), isAdmin);
      } else if (!isAdmin) {
        const personal = rows.filter(row => row.email === userEmail);
        const guests = rows.filter(row => row.email === 'гость');
        if (personal.length > 0) {
          html += '<div class="section-title">Ваши ссылки</div>';
          html += renderItems(personal, isAdmin);
        }
        if (personal.length > 0 && guests.length > 0) {
          html += '<hr>';
        }
        if (guests.length > 0) {
          html += '<div class="section-title">Ссылки гостей</div>';
          html += renderItems(guests, isAdmin);
        }
      } else {
        // Для админа отображаем все ссылки
        html = renderItems(rows, isAdmin);
      }
      linksList.innerHTML = html;

      document.querySelectorAll(".copy[data-copy]").forEach(btn => {
        btn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(btn.getAttribute("data-copy"));
            btn.textContent = "Скопировано ✓";
            setTimeout(() => btn.textContent = "Копировать", 1200);
          } catch (e) { alert("Не удалось скопировать"); }
        };
      });
      if (isAdmin) {
        document.querySelectorAll(".edit-btn").forEach(btn => {
          btn.onclick = () => {
            editLinkId.value = btn.getAttribute("data-id");
            editUrlInput.value = btn.getAttribute("data-url");
            editShortCode.value = btn.getAttribute("data-short");
            editModal.style.display = "flex";
          };
        });
        document.querySelectorAll(".delete-btn").forEach(btn => {
          btn.onclick = async () => {
            if (!confirm("Вы уверены, что хотите удалить эту ссылку?")) return;
            const id = btn.getAttribute("data-id");
            const { error } = await sb.from("q").delete().eq("id", id);
            if (error) { alert("Ошибка удаления: " + error.message); return; }
            loadLinks();
          };
        });
      }
    }

    function renderItems(rows, isAdmin) {
      return rows.map(row => {
        const shortUrl = `${window.location.origin}/${row.short}`;
        return `
          <div class="item">
            <div><span class="muted">Оригинал:</span> <a class="link" href="${row.url}" target="_blank">${row.url}</a></div>
            <div><span class="muted">Сокращённая:</span> <a class="link mono" href="${shortUrl}" target="_blank">${shortUrl}</a></div>
            ${isAdmin ? `<div><span class="muted">Email:</span> ${row.email}</div>` : ''}
            <div class="actions">
              <button class="copy" data-copy="${shortUrl}">Копировать</button>
              <a class="copy" href="${shortUrl}" target="_blank" style="text-decoration:none; display:inline-flex; align-items:center">Открыть</a>
              ${isAdmin ? `
                <button class="edit-btn" data-id="${row.id}" data-url="${row.url}" data-short="${row.short}">Редактировать</button>
                <button class="delete-btn btn-danger" data-id="${row.id}">Удалить</button>
              ` : ''}
            </div>
          </div>
        `;
      }).join("");
    }

    async function loadLinks() {
      const { user, isAdmin, email } = await getUserStatus();
      let query = sb.from("q").select("*").order("id", { ascending: false });
      if (!user) {
        query = query.eq("email", "гость");
      } else if (!isAdmin) {
        query = query.or(`email.eq.гость,email.eq.${email}`);
      }
      const { data, error } = await query;
      if (error) { console.error(error); return; }
      renderList(data, isAdmin, email);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const originalUrl = urlInput.value.trim();
      if (!/^https?:\/\//i.test(originalUrl)) {
        alert("Добавь http:// или https:// в начало ссылки");
        return;
      }
      const isUnsafe = await checkUrlSafety(originalUrl);
      if (isUnsafe) {
        alert("Эта ссылка признана небезопасной и не может быть сокращена");
        return;
      }
      let shortCode = customCode.value.trim() || generateShortCode(4);
      shortCode = sanitizeCode(shortCode);
      if (!shortCode) {
        alert("Неверный код");
        return;
      }
      const { data: exists, error: checkErr } = await sb.from("q").select("short").eq("short", shortCode).limit(1);
      if (checkErr) { alert("Ошибка проверки кода: " + checkErr.message); return; }
      if (exists && exists.length > 0) {
        alert("Этот код уже занят, выберите другой.");
        return;
      }
      const { user, email } = await getUserStatus();
      const { error } = await sb.from("q").insert([{ short: shortCode, url: originalUrl, email }]);
      if (error) { alert("Ошибка: " + error.message); return; }
      urlInput.value = ""; customCode.value = "";
      loadLinks();
    });

    editForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const { isAdmin } = await getUserStatus();
      if (!isAdmin) { alert("Только администратор может редактировать ссылки"); return; }
      const id = editLinkId.value;
      const newUrl = editUrlInput.value.trim();
      let newShortCode = sanitizeCode(editShortCode.value.trim());
      if (!/^https?:\/\//i.test(newUrl)) {
        alert("Добавь http:// или https:// в начало ссылки");
        return;
      }
      const isUnsafe = await checkUrlSafety(newUrl);
      if (isUnsafe) {
        alert("Эта ссылка признана небезопасной и не может быть использована");
        return;
      }
      if (!newShortCode) {
        alert("Неверный код");
        return;
      }
      const { data: exists, error: checkErr } = await sb.from("q").select("short").eq("short", newShortCode).neq("id", id).limit(1);
      if (checkErr) { alert("Ошибка проверки кода: " + checkErr.message); return; }
      if (exists && exists.length > 0) {
        alert("Этот код уже занят, выберите другой.");
        return;
      }
      const { error } = await sb.from("q").update({ url: newUrl, short: newShortCode }).eq("id", id);
      if (error) { alert("Ошибка обновления: " + error.message); return; }
      editModal.style.display = "none";
      loadLinks();
    });

    document.querySelector(".close-btn").addEventListener("click", () => {
      editModal.style.display = "none";
    });

    refreshBtn.addEventListener("click", loadLinks);

    getUserStatus();
    loadLinks();
  </script>
</body>
  </html>
