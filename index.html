<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Сокращатель ссылок — vyy.netlify.app</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#f7f8fa; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --primary:#3b82f6; --primary-600:#2563eb; --ring:rgba(59,130,246,.35);
      --shadow:0 6px 18px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, system-ui, Arial;
      display:flex; flex-direction:column; align-items:center; padding:24px;
    }
    .container{width:100%; max-width:720px}
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px;
    }
    .brand{font-size:22px; font-weight:700; letter-spacing:.2px}
    .status{
      padding:8px 12px; border-radius:999px; background:#eef2ff; color:#4338ca; font-weight:600; font-size:14px;
      white-space:nowrap;
    }
    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px; margin-bottom:16px;
    }
    label{display:block; font-size:13px; color:var(--muted); margin-top:8px}
    input{
      width:100%; padding:12px 14px; font-size:16px; margin-top:6px;
      border:1px solid #e5e7eb; border-radius:12px; outline:0; background:#fff;
      transition:border-color .15s, box-shadow .15s;
    }
    input:focus{border-color:var(--primary); box-shadow:0 0 0 4px var(--ring)}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:560px){ .row{grid-template-columns:2fr 1fr} }
    .btn{
      width:100%; padding:13px 16px; border:0; border-radius:12px; cursor:pointer;
      background:var(--primary); color:#fff; font-size:16px; font-weight:700;
      transition:transform .05s ease, background .15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn:hover{background:var(--primary-600)}
    .muted{color:var(--muted); font-size:14px}
    .list .item{
      background:#fff; border:1px solid #eef2f7; border-radius:12px; padding:12px;
      display:flex; flex-direction:column; gap:6px;
    }
    .list{display:grid; gap:10px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .link{
      color:var(--primary-600); text-decoration:none; word-break:break-all;
    }
    .top-actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px}
    .pill{
      padding:8px 10px; border-radius:999px; background:#f3f4f6; color:#111827; font-weight:600; font-size:13px;
    }
    .ghost{
      background:#fff; color:#111827; border:1px solid #e5e7eb;
    }
    .copy{
      padding:8px 10px; border-radius:10px; border:1px dashed #d1d5db; background:#fff; font-size:13px; cursor:pointer;
    }
    .empty{padding:10px 4px; color:var(--muted)}
    .auth-link{font-weight:700; text-decoration:none}
    footer{margin-top:16px; color:var(--muted); font-size:12px}
    .danger{ border:1px solid #fca5a5; color:#b91c1c; background:#fff; }
    .danger:hover{ background:#fee2e2; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">vyy • сокращатель</div>
      <div class="top-actions">
        <span id="status" class="status">Статус: Гость</span>
        <a id="authBtn" class="pill ghost auth-link" href="/auth.html">Войти / Регистрация</a>
        <button id="logoutBtn" class="pill ghost" style="display:none">Выйти</button>
        <button id="deleteAccBtn" class="pill danger" style="display:none">Удалить аккаунт</button>
      </div>
    </div>

    <div class="card">
      <form id="shortenForm">
        <label>Оригинальная ссылка</label>
        <input type="url" id="urlInput" required placeholder="https://example.com/very/long/link" />
        <div class="row">
          <div>
            <label>Свой короткий код (необязательно)</label>
            <input type="text" id="customCode" inputmode="latin" pattern="[A-Za-z0-9-_.~]{1,16}" placeholder="Например: go" />
          </div>
          <div style="display:flex; align-items:flex-end">
            <button type="submit" class="btn">Сократить</button>
          </div>
        </div>
        <div class="muted" style="margin-top:6px">Короткие ссылки вида <span class="mono">https://vyy.netlify.app/&lt;код&gt;</span></div>
      </form>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px">
        <h3 style="margin:0; font-size:18px">Все ссылки</h3>
        <button id="refreshBtn" class="copy">Обновить</button>
      </div>
      <div id="linksList" class="list"></div>
      <div id="emptyState" class="empty" style="display:none">Пока пусто. Добавьте первую ссылку ↑</div>
    </div>

    <footer>© vyy • работает на Supabase + Netlify</footer>
  </div>

  <script>
    const SUPABASE_URL = "https://jkjahrrewfrcnfojpetn.supabase.co";
    const SUPABASE_KEY = "YOUR_KEY"; // вставь свой
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const ADMIN_UID = "f34c5c47-5a4f-4006-ac9e-a4288448d09b";

    const statusEl = document.getElementById("status");
    const authBtn = document.getElementById("authBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const deleteAccBtn = document.getElementById("deleteAccBtn");
    const urlInput = document.getElementById("urlInput");
    const customCode = document.getElementById("customCode");
    const linksList = document.getElementById("linksList");
    const emptyState = document.getElementById("emptyState");
    const refreshBtn = document.getElementById("refreshBtn");

    let IS_ADMIN = false;

    function generateShortCode(length = 4) {
      const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      return Array.from({ length }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    function sanitizeCode(code) {
      return code.replace(/[^A-Za-z0-9\-_.~]/g, "").slice(0, 32);
    }

    async function updateStatus() {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) {
        IS_ADMIN = false;
        statusEl.textContent = "Статус: Гость";
        authBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        deleteAccBtn.style.display = "none";
        return;
      }
      IS_ADMIN = (user.id === ADMIN_UID);
      statusEl.textContent = IS_ADMIN ? "Статус: Админ" : "Статус: Пользователь";
      authBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      deleteAccBtn.style.display = "inline-block";
    }

    async function logout() {
      await sb.auth.signOut();
      location.reload();
    }

    async function deleteAccount() {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) return;
      // Удаляем все его ссылки
      await sb.from("q").delete().eq("user_id", user.id);
      // Удаляем пользователя
      await sb.auth.admin.deleteUser(user.id);
      alert("Аккаунт удалён");
      location.reload();
    }

    function attachCopyHandlers() {
      document.querySelectorAll(".copy[data-copy]").forEach(btn=>{
        btn.onclick = async () => {
          await navigator.clipboard.writeText(btn.getAttribute("data-copy"));
          btn.textContent = "Скопировано ✓";
          setTimeout(()=> btn.textContent="Копировать", 1200);
        };
      });
    }

    function attachDeleteHandlers() {
      document.querySelectorAll(".btn-delete").forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute("data-id");
          await sb.from("q").delete().eq("id", id).limit(1);
          loadLinks();
        };
      });
    }

    function renderList(rows) {
      if (!rows || rows.length === 0) {
        linksList.innerHTML = "";
        emptyState.style.display = "block";
        return;
      }
      emptyState.style.display = "none";
      linksList.innerHTML = rows.map(row => {
        const shortUrl = `${window.location.origin}/${row.short}`;
        return `
          <div class="item">
            <div><span class="muted">Оригинал:</span> <a class="link" href="${row.url}" target="_blank">${row.url}</a></div>
            <div><span class="muted">Сокращённая:</span> <a class="link mono" href="${shortUrl}" target="_blank">${shortUrl}</a></div>
            <div style="display:flex; gap:8px; margin-top:6px">
              <button class="copy" data-copy="${shortUrl}">Копировать</button>
              <a class="copy" href="${shortUrl}" target="_blank">Открыть</a>
              ${IS_ADMIN ? `<button class="copy danger btn-delete" data-id="${row.id}">Удалить</button>` : ``}
            </div>
          </div>
        `;
      }).join("");
      attachCopyHandlers();
      if (IS_ADMIN) attachDeleteHandlers();
    }

    async function loadLinks() {
      const { data, error } = await sb.from("q").select("*").order("id", { ascending: false });
      if (!error) renderList(data);
    }

    document.getElementById("shortenForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const originalUrl = urlInput.value.trim();
      if (!/^https?:\/\//i.test(originalUrl)) {
        alert("Добавь http:// или https:// в начало ссылки");
        return;
      }
      let shortCode = customCode.value.trim() || generateShortCode(4);
      shortCode = sanitizeCode(shortCode);
      const { data: exists } = await sb.from("q").select("short").eq("short", shortCode).limit(1);
      if (exists?.length) return alert("Этот код уже занят.");
      await sb.from("q").insert([{ short: shortCode, url: originalUrl }]);
      urlInput.value = ""; customCode.value = "";
      loadLinks();
    });

    logoutBtn.addEventListener("click", logout);
    deleteAccBtn.addEventListener("click", deleteAccount);
    refreshBtn.addEventListener("click", loadLinks);

    (async () => {
      await updateStatus();
      await loadLinks();
    })();
  </script>
</body>
</html>
